generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Supported blockchain networks
enum Chain {
  SOLANA
  AVALANCHE
}

// Trade side
enum TradeSide {
  BUY
  SELL
}

// Trade status
enum TradeStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FAILED
  EXPIRED
}

// Bot instance status
enum BotStatus {
  STOPPED
  RUNNING
  PAUSED
  ERROR
}

// Alert types
enum AlertType {
  BOT_STARTED
  BOT_STOPPED
  TRADE_EXECUTED
  TRADE_FAILED
  CIRCUIT_BREAKER
  DAILY_SUMMARY
  ERROR
}

// Trade size mode
enum TradeSizeMode {
  FIXED_QUOTE
  FIXED_BASE
  PERCENT_BALANCE
}

// Compounding mode for calculated trade sizing
enum CompoundingMode {
  FIXED           // Always use fixed tradeSize (original behavior)
  FULL_BALANCE    // Use full available balance minus reserve
  CALCULATED      // Calculate based on realized gains with reserve buffer
}

// Starting mode for new bots
enum StartingMode {
  START_BY_BUYING
  START_BY_SELLING
  START_NEUTRAL
}

// PnL calculation method
enum PnLMethod {
  AVERAGE_COST
  FIFO
}

// Exit mode for sell strategy
enum ExitMode {
  FULL_EXIT     // Default: sell entire position at target
  SCALE_OUT     // Sell primary portion, hold remainder for extension
}

// Cycle mode for buy/sell strategy
enum CycleMode {
  STANDARD        // Default: simple buy-dip/sell-rise loop
  ROLLING_REBUY   // Partial sell (primarySellPct) + rebuy on dip
}

// Extension state for scale-out mode
enum ExtensionState {
  NONE          // No active extension
  ACTIVE        // Extension in progress, holding remainder
  TRAILING      // Trailing stop activated (if enabled)
}

// Bot configuration - stores all user-configurable parameters
model BotConfig {
  id                    String        @id @default(cuid())
  name                  String
  chain                 Chain
  baseMint              String        // SOL mint or WAVAX address
  quoteMint             String        // USDC mint/address

  // Strategy parameters
  buyDipPct             Float         @default(2.0)    // Buy when price drops X% from last sell
  sellRisePct           Float         @default(5.0)    // Sell when price rises X% from last buy
  tradeSizeMode         TradeSizeMode @default(FIXED_QUOTE)
  tradeSize             Float         @default(25.0)   // Size in quote (USDC) or base depending on mode
  minTradeNotional      Float         @default(10.0)   // Minimum trade size in USDC
  maxSlippageBps        Int           @default(50)     // Max slippage in basis points
  maxPriceImpactBps     Int?          @default(100)    // Max price impact if available

  // Timing
  cooldownSeconds       Int           @default(60)     // Min seconds between trades
  maxTradesPerHour      Int           @default(10)

  // Safety controls
  dailyLossLimitUsdc    Float?        @default(50.0)   // Stop if daily loss exceeds this
  maxDrawdownPct        Float?        @default(10.0)   // Stop if drawdown exceeds this
  maxConsecutiveFailures Int          @default(3)
  minBaseReserve        Float         @default(0.01)   // Keep this much SOL/AVAX for gas
  minQuoteReserve       Float         @default(5.0)    // Keep this much USDC as reserve

  // Take profit / stop loss at portfolio level
  takeProfitUsdc        Float?
  stopLossUsdc          Float?

  // Starting configuration
  startingMode          StartingMode  @default(START_BY_BUYING)

  // PnL method
  pnlMethod             PnLMethod     @default(AVERAGE_COST)

  // Liquidity source preferences
  allowedSources        String[]      @default([])     // Empty = all allowed
  excludedSources       String[]      @default([])

  // Price sanity check
  maxPriceDeviationBps  Int           @default(200)    // Max deviation from secondary source

  // RPC and API configuration (encrypted/env-referenced)
  rpcUrl                String?       // Optional override

  // Dry run mode (quotes only, no execution)
  dryRunMode            Boolean       @default(false)

  // === CAPITAL ALLOCATION ===
  // Initial USDC capital allocated to this bot (for capital isolation)
  initialCapitalUSDC    Float?        // null = no capital isolation (uses full wallet)

  // === EXECUTION COST & NET EDGE CONFIGURATION ===
  // Minimum net edge required to execute (default 0.40%)
  minimumNetEdgePct     Float         @default(0.40)

  // Estimated DEX fee percentage (varies by venue)
  estimatedDexFeePct    Float         @default(0.05)

  // Priority fee impact estimate (Solana-specific)
  priorityFeeImpactPct  Float         @default(0.02)

  // === SPLIT EXECUTION CONFIGURATION ===
  // Max slippage for single-shot execution (default 0.25%)
  maxSingleTradeSlippagePct Float     @default(0.25)

  // Target slippage per chunk in split execution (default 0.15%)
  targetChunkSlippagePct    Float     @default(0.15)

  // Minimum chunk size in USDC
  minChunkSizeUsdc          Float     @default(50.0)

  // Maximum chunks per split execution
  maxChunksPerSplit         Int       @default(10)

  // === DYNAMIC PROFIT TARGET TIERS ===
  // When execution cost > 0.30%, use this sell target
  sellTargetTier1Pct        Float     @default(1.4)
  // When execution cost > 0.50%, use this sell target
  sellTargetTier2Pct        Float     @default(1.6)
  // When execution cost > 0.70%, DO NOT TRADE
  maxExecutionCostPct       Float     @default(0.70)

  // === CAPITAL-AWARE THRESHOLDS ===
  // Portfolio value tiers for execution behavior
  capitalTier1Usdc          Float     @default(5000)    // Below: single-shot only
  capitalTier2Usdc          Float     @default(20000)   // Below: conditional split
  capitalTier3Usdc          Float     @default(50000)   // Above: mandatory split

  // === REGIME ADAPTATION ===
  // Enable automatic parameter adaptation based on regime
  enableRegimeAdaptation    Boolean   @default(true)

  // Pause trading in CHAOS regime
  pauseInChaosRegime        Boolean   @default(true)

  // Volatility threshold for CHAOS detection (%)
  chaosVolatilityThreshold  Float     @default(5.0)

  // Range threshold for CHOP detection (%)
  chopRangeThreshold        Float     @default(1.5)

  // === SCALE-OUT EXIT MODE ===
  // Exit mode: FULL_EXIT (default) or SCALE_OUT
  exitMode                  ExitMode  @default(FULL_EXIT)

  // Primary exit percentage (default 65%)
  scaleOutPrimaryPct        Float     @default(0.65)

  // Secondary/extension percentage (default 35%)
  scaleOutSecondaryPct      Float     @default(0.35)

  // Target for secondary exit (default 1.9%)
  scaleOutSecondaryTargetPct Float    @default(1.9)

  // Enable trailing stop for extension (default false)
  scaleOutTrailingEnabled   Boolean   @default(false)

  // Minimum price extension to justify holding (default 0.3%)
  scaleOutMinExtensionPct   Float     @default(0.3)

  // Minimum dollar profit to justify scale-out (default $2)
  scaleOutMinDollarProfit   Float     @default(2.0)

  // Trailing stop percentage from peak (default 1.0%)
  scaleOutTrailingStopPct   Float     @default(1.0)

  // Allow scale-out for WHALE tier (default false, requires explicit enable)
  scaleOutAllowWhale        Boolean   @default(false)

  // === COMPOUNDING MODE CONFIGURATION ===
  // Compounding mode for calculated trade sizing
  compoundingMode           CompoundingMode @default(FIXED)

  // Initial trade size (optional - for CALCULATED mode baseline)
  initialTradeSizeUsdc      Float?

  // Reserve percentage to hold back from compounding (default 5%)
  compoundingReservePct     Float     @default(5.0)

  // === MULTI-STEP SCALE-OUT CONFIGURATION ===
  // Number of scale-out exit steps (default 1 = original behavior)
  scaleOutSteps             Int       @default(1)

  // Total percentage range for scale-out exits (default 2.0% above entry)
  scaleOutRangePct          Float     @default(2.0)

  // Custom spacing between scale-out levels (optional - auto-calculated if null)
  scaleOutSpacingPct        Float?

  // === ROLLING REBUY CONFIGURATION ===
  // Cycle mode: STANDARD (default) or ROLLING_REBUY
  cycleMode                 CycleMode @default(STANDARD)

  // Primary sell percentage for ROLLING_REBUY mode (default 80%)
  primarySellPct            Float     @default(80.0)

  // Allow rebuy after partial sell (default false)
  allowRebuy                Boolean   @default(false)

  // Maximum number of rebuys per cycle (default 1)
  maxRebuyCount             Int       @default(1)

  // Exposure cap as percentage of portfolio (default 50%)
  exposureCapPct            Float     @default(50.0)

  // Only rebuy in favorable regimes (CHOP/TREND, not CHAOS)
  rebuyRegimeGate           Boolean   @default(true)

  // Dip percentage required to trigger rebuy (default same as buyDipPct)
  rebuyDipPct               Float?

  // === RESERVE RESET CONFIGURATION ===
  // Enable reserve reset behavior (adaptive 3-bucket strategy)
  enableReserveReset        Boolean   @default(false)

  // Percentage of allocated capital reserved for resets (default 66%)
  resetReservePct           Float     @default(66.0)

  // Maximum reserve deployments per cycle before reverting to standard behavior
  maxReserveDeploymentsPerCycle Int   @default(2)

  // --- Rescue Buy (downside reset) ---
  // Price drop % from lastBuyPrice to trigger rescue buy
  rescueTriggerPct          Float     @default(2.5)

  // Percentage of reserve to deploy on rescue (default 50%)
  rescueDeployPctOfReserve  Float     @default(50.0)

  // Max rescue buys per cycle
  maxRescueBuysPerCycle     Int       @default(1)

  // Rescue regime gate: NONE, TREND_ONLY, CHAOS_ONLY, TREND_OR_CHAOS
  rescueRegimeGate          String    @default("TREND_OR_CHAOS")

  // --- Chase Buy (upside reset / participation re-entry) ---
  // Price rise % above lastSellPrice to trigger chase buy
  chaseTriggerPct           Float     @default(3.0)

  // Percentage of reserve to deploy on chase (default 33%)
  chaseDeployPctOfReserve   Float     @default(33.0)

  // Profit target for chase exit (from new basis)
  chaseExitTargetPct        Float     @default(1.2)

  // Chase regime gate: NONE, TREND_UP_ONLY, TREND_ONLY
  chaseRegimeGate           String    @default("TREND_UP_ONLY")

  // Alerting
  webhookUrl            String?
  discordWebhookUrl     String?

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  instances             BotInstance[]

  @@index([chain])
}

// Running bot instance
model BotInstance {
  id                    String        @id @default(cuid())
  configId              String
  config                BotConfig     @relation(fields: [configId], references: [id], onDelete: Cascade)

  status                BotStatus     @default(STOPPED)

  // Reference prices for strategy decisions
  lastBuyPrice          Float?        // USDC per base (SOL/AVAX)
  lastSellPrice         Float?        // USDC per base
  lastTradeAt           DateTime?

  // Cumulative tracking
  totalBuys             Int           @default(0)
  totalSells            Int           @default(0)
  totalBuyVolume        Float         @default(0)    // in quote (USDC)
  totalSellVolume       Float         @default(0)

  // Cost basis tracking
  totalBaseCost         Float         @default(0)    // Total USDC spent on current base holdings
  totalBaseQty          Float         @default(0)    // Current base holdings tracked by bot

  // === SCALE-OUT EXTENSION STATE ===
  // Current extension state
  extensionState        ExtensionState @default(NONE)

  // Remaining base qty in extension (subset of totalBaseQty)
  extensionBaseQty      Float         @default(0)

  // Cost basis for extension portion
  extensionBaseCost     Float         @default(0)

  // Price at which primary exit occurred
  extensionEntryPrice   Float?

  // Peak price since extension started (for trailing)
  extensionPeakPrice    Float?

  // Timestamp when extension started
  extensionStartedAt    DateTime?

  // Realized PnL from primary exit (before extension completes)
  extensionPrimaryPnl   Float         @default(0)

  // === ROLLING REBUY STATE ===
  // Number of rebuys executed in current cycle
  rebuyCount            Int           @default(0)

  // Price at which last rebuy occurred
  lastRebuyPrice        Float?

  // Timestamp of last rebuy
  lastRebuyAt           DateTime?

  // === CAPITAL ALLOCATION STATE ===
  // Virtual allocated capital (for multi-bot capital isolation)
  allocatedUSDC         Float         @default(0)    // Current USDC allocation
  allocatedSOL          Float         @default(0)    // Current SOL allocation

  // Reserved for pending transactions
  reservedUSDCForFees   Float         @default(0)    // Reserved for estimated fees
  pendingBuyUSDC        Float         @default(0)    // USDC locked in pending buys
  pendingSellSOL        Float         @default(0)    // SOL locked in pending sells

  // Cumulative realized PnL (persisted)
  cumulativeRealizedPnL Float         @default(0)    // Total lifetime realized PnL

  // Safety state
  consecutiveFailures   Int           @default(0)
  tradesThisHour        Int           @default(0)
  hourlyResetAt         DateTime      @default(now())
  dailyRealizedPnl      Float         @default(0)
  dailyResetAt          DateTime      @default(now())

  // Error tracking
  lastError             String?
  lastErrorAt           DateTime?

  // Pause reason
  pauseReason           String?

  startedAt             DateTime?
  stoppedAt             DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  tradeAttempts         TradeAttempt[]
  positionSnapshots     PositionSnapshot[]
  pnlSnapshots          PnLSnapshot[]
  alerts                AlertEvent[]
  marketAnalytics       MarketAnalytics[]
  tradeRejections       TradeRejection[]
  splitExecutions       SplitExecution[]

  @@index([configId])
  @@index([status])
}

// Individual trade attempt (may succeed or fail)
model TradeAttempt {
  id                    String        @id @default(cuid())
  instanceId            String
  instance              BotInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Idempotency key to prevent duplicate execution
  clientOrderId         String        @unique

  side                  TradeSide
  status                TradeStatus   @default(PENDING)

  // Dry run flag - synthetic trades for simulation
  isDryRun              Boolean       @default(false)

  // Quote data
  quotePrice            Float         // Expected price from quote
  quotedBaseQty         Float
  quotedQuoteQty        Float
  quotedPriceImpactBps  Int?
  quotedSlippageBps     Int?

  // Transaction data
  txSignature           String?       // Solana signature or Avalanche tx hash

  // Execution result (filled from on-chain data)
  fill                  TradeFill?

  // Error details
  errorCode             String?
  errorMessage          String?

  attemptedAt           DateTime      @default(now())
  submittedAt           DateTime?
  confirmedAt           DateTime?

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([instanceId])
  @@index([status])
  @@index([clientOrderId])
}

// Confirmed trade fill with actual execution data
model TradeFill {
  id                    String        @id @default(cuid())
  attemptId             String        @unique
  attempt               TradeAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  side                  TradeSide

  // Actual execution amounts (from on-chain data)
  baseQty               Float         // Amount of SOL/AVAX traded
  quoteQty              Float         // Amount of USDC traded
  executedPrice         Float         // quoteQty / baseQty

  // Fees
  feeQuote              Float         @default(0)    // Fee in quote currency
  feeNative             Float         @default(0)    // Gas/network fee in native token
  feeNativeUsdc         Float         @default(0)    // Gas fee converted to USDC

  // Actual slippage
  actualSlippageBps     Int?

  // For PnL calculation (set at fill time)
  costBasisPerUnit      Float?        // For sells: avg cost per base unit sold
  realizedPnl           Float?        // For sells: profit/loss on this trade

  // Transaction details
  txSignature           String
  blockNumber           BigInt?       // For Avalanche
  slot                  BigInt?       // For Solana

  executedAt            DateTime
  createdAt             DateTime      @default(now())

  @@index([attemptId])
  @@index([executedAt])
}

// Periodic position snapshots for charting
model PositionSnapshot {
  id                    String        @id @default(cuid())
  instanceId            String
  instance              BotInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Balances at snapshot time
  baseBalance           Float         // SOL/AVAX balance
  quoteBalance          Float         // USDC balance

  // Current price
  markPrice             Float         // Current executable price

  // Portfolio value
  totalValueUsdc        Float         // baseBalance * markPrice + quoteBalance

  snapshotAt            DateTime      @default(now())

  @@index([instanceId])
  @@index([snapshotAt])
}

// Daily PnL snapshots
model PnLSnapshot {
  id                    String        @id @default(cuid())
  instanceId            String
  instance              BotInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  date                  DateTime      @db.Date

  // PnL figures
  realizedPnl           Float         // Sum of realized PnL for the day
  unrealizedPnl         Float         // Mark-to-market unrealized at end of day
  totalPnl              Float         // realized + unrealized

  // Fee totals
  totalFees             Float         // Quote currency fees
  totalGasFees          Float         // Gas fees in USDC equivalent

  // Trade counts
  buyCount              Int
  sellCount             Int
  buyVolume             Float
  sellVolume            Float

  // Portfolio value at snapshot
  portfolioValue        Float

  createdAt             DateTime      @default(now())

  @@unique([instanceId, date])
  @@index([instanceId])
  @@index([date])
}

// Alert and notification events
model AlertEvent {
  id                    String        @id @default(cuid())
  instanceId            String?
  instance              BotInstance?  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  type                  AlertType
  title                 String
  message               String
  metadata              Json?

  // Delivery status
  webhookDelivered      Boolean       @default(false)
  webhookError          String?
  discordDelivered      Boolean       @default(false)
  discordError          String?

  createdAt             DateTime      @default(now())

  @@index([instanceId])
  @@index([type])
  @@index([createdAt])
}

// Market regime classification
enum MarketRegime {
  CHOP      // Tight ranges, frequent reversals, fast cycles
  TREND     // One-sided movement, long holding times
  CHAOS     // Volatility spikes, slippage instability
  UNKNOWN   // Insufficient data
}

// Trade rejection reason codes
enum TradeRejectionReason {
  NET_EDGE_TOO_LOW
  EXECUTION_COST_TOO_HIGH
  SLIPPAGE_EXCEEDED
  PRICE_IMPACT_EXCEEDED
  REGIME_CHAOS_PAUSE
  CAPITAL_TIER_RESTRICTION
  COOLDOWN_ACTIVE
  RATE_LIMIT_EXCEEDED
  INSUFFICIENT_CAPITAL       // Capital allocation: not enough USDC for BUY
  SELL_NOT_PROFITABLE        // Capital allocation: SELL would not be profitable (NO L rule)
  WALLET_GUARDRAIL_FAILED    // Capital allocation: wallet balance insufficient for allocations
}

// Hourly market analytics for regime detection
model MarketAnalytics {
  id                    String        @id @default(cuid())
  instanceId            String
  instance              BotInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Time bucket
  hourStart             DateTime

  // Price range data
  priceHigh             Float
  priceLow              Float
  priceOpen             Float
  priceClose            Float
  priceRangePct         Float         // (high - low) / open * 100

  // Volatility metrics
  volatility1h          Float         // Standard deviation of price samples
  avgSlippageBps        Float         // Average actual slippage this hour
  maxSlippageBps        Float         // Max slippage observed

  // Cycle metrics
  cyclesCompleted       Int           @default(0)   // BUY->SELL pairs completed
  avgCycleTimeMinutes   Float?        // Average time from buy to sell
  avgCycleProfitPct     Float?        // Average profit per cycle

  // Trade counts
  buyCount              Int           @default(0)
  sellCount             Int           @default(0)
  rejectedCount         Int           @default(0)
  failedCount           Int           @default(0)

  // Execution quality
  avgExecutionCostPct   Float?        // Average total execution cost
  avgNetEdgePct         Float?        // Average net edge achieved

  // Regime classification
  detectedRegime        MarketRegime  @default(UNKNOWN)

  createdAt             DateTime      @default(now())

  @@unique([instanceId, hourStart])
  @@index([instanceId])
  @@index([hourStart])
  @@index([detectedRegime])
}

// Trade rejection log for analysis
model TradeRejection {
  id                    String               @id @default(cuid())
  instanceId            String
  instance              BotInstance          @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  side                  TradeSide
  reason                TradeRejectionReason

  // Metrics at rejection time
  intendedSizeUsdc      Float
  currentPrice          Float
  quotedSlippagePct     Float?
  estimatedFeePct       Float?
  executionCostPct      Float?
  netEdgePct            Float?
  sellTargetPct         Float?
  portfolioValueUsdc    Float?

  // Context
  currentRegime         MarketRegime?
  capitalTier           String?

  createdAt             DateTime      @default(now())

  @@index([instanceId])
  @@index([reason])
  @@index([createdAt])
}

// Split execution tracking
model SplitExecution {
  id                    String        @id @default(cuid())
  instanceId            String
  instance              BotInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Parent order info
  parentOrderId         String        @unique
  side                  TradeSide
  totalIntendedSize     Float         // Total amount intended
  totalChunks           Int           // Planned number of chunks

  // Aggregated results
  completedChunks       Int           @default(0)
  abortedChunks         Int           @default(0)
  totalBaseExecuted     Float         @default(0)
  totalQuoteExecuted    Float         @default(0)
  weightedAvgPrice      Float?        // Weighted average execution price
  totalFees             Float         @default(0)
  totalSlippageCost     Float         @default(0)

  // Status
  status                TradeStatus   @default(PENDING)
  abortReason           String?

  startedAt             DateTime      @default(now())
  completedAt           DateTime?

  // Individual chunk records
  chunks                SplitChunk[]

  @@index([instanceId])
  @@index([parentOrderId])
}

// Individual chunk within a split execution
model SplitChunk {
  id                    String        @id @default(cuid())
  splitExecutionId      String
  splitExecution        SplitExecution @relation(fields: [splitExecutionId], references: [id], onDelete: Cascade)

  chunkIndex            Int
  intendedSize          Float

  // Quote at execution time
  quotedPrice           Float?
  quotedSlippageBps     Int?

  // Execution result
  status                TradeStatus   @default(PENDING)
  executedBaseQty       Float?
  executedQuoteQty      Float?
  executedPrice         Float?
  actualSlippageBps     Int?
  feeNativeUsdc         Float?

  txSignature           String?
  errorMessage          String?

  attemptedAt           DateTime      @default(now())
  completedAt           DateTime?

  @@index([splitExecutionId])
}
